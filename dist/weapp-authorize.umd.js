(function(n,s){typeof exports=="object"&&typeof module!="undefined"?module.exports=s():typeof define=="function"&&define.amd?define(s):(n=typeof globalThis!="undefined"?globalThis:n||self,n["weapp-authorize"]=s())})(this,function(){"use strict";class n{constructor(){this.scopeNames=["userLocation","userLocationBackground","record","camera","bluetooth","writePhotosAlbum","addPhoneContact","addPhoneCalendar","werun"],this.init()}get page(){const t=getCurrentPages();return t[t.length-1]}init(){this.scopeMap=Array.from({length:this.scopeNames.length},()=>[]),Array.from(this.scopeNames,(t,e)=>{this.scopeMap[e]=this.genCharCode(t)})}genCharCode(t){if(!t)return[];const e=Array.from({length:26},()=>0);let h=-1;for(;++h<t.length;)e[t[h].toLowerCase().charCodeAt(0)-"a".charCodeAt(0)]+=1;return e}compare(t){if(!t)throw Error(`scope "${t||""}" not found, do you mean "${this.scopeNames[0]}"?`);if(this.scopeNames.includes(t))return;let e=this.genCharCode(t),h=0,o=0,r="";throw Array.from(this.scopeMap,(i,d)=>{h=0;for(let u=0;u<26;u++)h+=Math.abs(i[u]-e[u]);let f=t.match(/[^a-zA-Z]*/g);f&&f.length&&(h+=f.join("").length),o=o?Math.min(h,o):h,r=Math.min(h,o)===h?this.scopeNames[d]:r,console.log("compare",t,this.scopeNames[d],h,o,r)}),Error(`scope "${t}" not found, do you mean "${r}"?`)}authStateSettle(t,e){this.page.setData({[t+"Auth"]:e})}recheck(t,e,h){this.compare(t);const o="scope."+t;wx.getSetting({success:r=>{if(r.authSetting[o]){this.authStateSettle(t,!0),e&&e(r);return}wx.openSetting({success:i=>{this.authStateSettle(t,!0),e&&e(i)},fail:i=>{this.authStateSettle(t,!1),h&&h(i)}})},fail:r=>{this.authStateSettle(t,!1),h&&h(r)}})}opensetting(t,e,h,o){this.compare(e);const r="scope."+e;t.detail.authSetting[r]?(this.authStateSettle(e,!0),h&&h("")):(this.authStateSettle(e,!1),o&&o(""))}check(t,e,h){this.compare(t);const o="scope."+t;wx.getSetting({success:r=>{if(r.authSetting[o]){this.authStateSettle(t,!0),e&&e(r);return}wx.authorize({scope:o,success:i=>{this.authStateSettle(t,!0),e&&e(i)},fail:i=>{this.authStateSettle(t,!1),h&&h(i)}})},fail:r=>{this.authStateSettle(t,!1),h&&h(r)}})}auth(t,e,h,o){if(typeof t=="string"){t=null,e=t,this.recheck(e,h,o);return}let r=e;typeof t=="object"&&((!e||typeof e=="function")&&(r=t.currentTarget.dataset.scope),t.detail.authSetting?this.opensetting(t,r,h,o):this.recheck(r,h,o))}}return new n});
